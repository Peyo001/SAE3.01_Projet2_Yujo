{% extends "base_template.html.twig" %}

{% block title %}Nouveau Post{% endblock %}

{% block content %}
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0">
                        <h1 class="h4 mb-0">Créer un nouveau post</h1>
                    </div>
                    <div class="card-body">
                        {% if erreurs is defined and erreurs is not empty %}
                            <div class="alert alert-danger">
                                <div class="fw-semibold mb-2">Veuillez corriger les erreurs suivantes :</div>
                                <ul class="mb-0">
                                    {% for msg in erreurs %}
                                        <li>{{ msg }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        <form action="index.php?controleur=post&methode=traiterFormulaireInsertion" method="post" enctype="multipart/form-data">
                            <div class="row g-3 mb-2">
                                <div class="col-12 col-md-6">
                                    <label for="type_post" class="form-label">Type de contenu</label>
                                    <select name="type_post" id="type_post" class="form-select" onchange="toggleFields()">
                                        <option value="post" {% if donnees.type_post|default('post') == 'post' %}selected{% endif %}>Post texte / image</option>
                                        <option value="quiz" {% if donnees.type_post|default('post') == 'quiz' %}selected{% endif %}>Quiz interactif</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="visibilite" class="form-label">Visibilité</label>
                                    <select name="visibilite" id="visibilite" class="form-select">
                                        <option value="public" {% if donnees.visibilite|default('public') == 'public' %}selected{% endif %}>Public</option>
                                        <option value="prive" {% if donnees.visibilite|default('public') == 'prive' %}selected{% endif %}>Privé</option>
                                    </select>
                                </div>
                            </div>

                            <div id="postFields" class="mb-3">
                                <label for="contenu" class="form-label">Votre message</label>
                                <textarea name="contenu" id="contenu" rows="6" class="form-control" minlength="1" maxlength="5000" placeholder="Écrire votre message...">{{ donnees.contenu|default('') }}</textarea>
                            </div>

                            <div id="imageFields" class="mb-3" style="display: none;">
                                <label for="image" class="form-label">Choisir une image</label>
                                <input type="file" name="image" id="image" accept="image/*" class="form-control">
                                <div class="form-text">Formats acceptés: JPG, PNG, GIF, WebP — Taille max: 5MB</div>
                            </div>

                            <div id="quizFields" class="mb-3" style="display: none;">
                                <div class="border rounded p-3">
                                    <h2 class="h6">Configuration du quiz</h2>
                                    <div class="mb-3">
                                        <label for="titre_quiz" class="form-label">Titre du quiz</label>
                                        <input type="text" name="titre_quiz" id="titre_quiz" class="form-control" placeholder="Ex: Quiz sur les capitales européennes">
                                    </div>
                                    <div class="mb-3">
                                        <label for="description_quiz" class="form-label">Description</label>
                                        <textarea name="description_quiz" id="description_quiz" rows="3" class="form-control" placeholder="Décrivez votre quiz..."></textarea>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input type="checkbox" name="choix_multiples" value="1" class="form-check-input" id="choix_multiples">
                                        <label class="form-check-label" for="choix_multiples">Autoriser les choix multiples</label>
                                    </div>
                                    <div class="mb-3">
                                        <label for="question_libelle" class="form-label">Question principale</label>
                                        <input type="text" name="question_libelle" id="question_libelle" class="form-control" placeholder="Quelle est la capitale de la France ?">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Réponses possibles</label>
                                        <div class="text-muted small mb-2">Ajoutez au moins 2 réponses et cochez la ou les bonnes réponses.</div>

                                        <div class="row g-2 align-items-center mb-2">
                                            <div class="col-1 text-end">1.</div>
                                            <div class="col-9"><input type="text" name="reponses[0][libelle]" class="form-control" placeholder="Réponse 1"></div>
                                            <div class="col-2 form-check">
                                                <input type="checkbox" class="form-check-input" id="rep0" name="reponses[0][correct]" value="1">
                                                <label class="form-check-label" for="rep0">Correcte</label>
                                            </div>
                                        </div>
                                        <div class="row g-2 align-items-center mb-2">
                                            <div class="col-1 text-end">2.</div>
                                            <div class="col-9"><input type="text" name="reponses[1][libelle]" class="form-control" placeholder="Réponse 2"></div>
                                            <div class="col-2 form-check">
                                                <input type="checkbox" class="form-check-input" id="rep1" name="reponses[1][correct]" value="1">
                                                <label class="form-check-label" for="rep1">Correcte</label>
                                            </div>
                                        </div>
                                        <div class="row g-2 align-items-center mb-2">
                                            <div class="col-1 text-end">3.</div>
                                            <div class="col-9"><input type="text" name="reponses[2][libelle]" class="form-control" placeholder="Réponse 3 (optionnel)"></div>
                                            <div class="col-2 form-check">
                                                <input type="checkbox" class="form-check-input" id="rep2" name="reponses[2][correct]" value="1">
                                                <label class="form-check-label" for="rep2">Correcte</label>
                                            </div>
                                        </div>
                                        <div class="row g-2 align-items-center">
                                            <div class="col-1 text-end">4.</div>
                                            <div class="col-9"><input type="text" name="reponses[3][libelle]" class="form-control" placeholder="Réponse 4 (optionnel)"></div>
                                            <div class="col-2 form-check">
                                                <input type="checkbox" class="form-check-input" id="rep3" name="reponses[3][correct]" value="1">
                                                <label class="form-check-label" for="rep3">Correcte</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end">
                                <a href="index.php?controleur=accueil&methode=afficher" class="btn btn-outline-secondary">Annuler</a>
                                <button type="submit" class="btn btn-cta" id="btnPublier">Publier</button>
                            </div>
                        </form>
                    </div>
                </div>

                {% if erreurs is defined and erreurs is not empty %}
                {# Erreurs déjà affichées dans la carte ci-dessus #}
                {% endif %}
            </div>
        </div>
    </div>

    {% block scripts %}
    <script>
        function toggleFields() {
            const type = document.getElementById('type_post').value;
            const imageFields = document.getElementById('imageFields');
            const quizFields = document.getElementById('quizFields');
            const postFields = document.getElementById('postFields');

            if (imageFields) imageFields.style.display = (type === 'post') ? 'block' : 'none';
            if (quizFields) quizFields.style.display = (type === 'quiz') ? 'block' : 'none';
            if (postFields) postFields.style.display = (type === 'post') ? 'block' : 'none';
        }
        document.addEventListener('DOMContentLoaded', () => {
            toggleFields();
            const form = document.querySelector('form');
            const btnPublier = document.getElementById('btnPublier');
            if (form && btnPublier) {
                form.addEventListener('submit', () => {
                    btnPublier.disabled = true;
                    btnPublier.textContent = 'Publication en cours...';
                });
            }
        });
    </script>
    {% endblock %}
{% endblock %}